name: collect-trends-via-api

on:
  schedule:
    # KST: 00:20 / 04:20 / 08:20 / 12:20 / 16:20 / 20:20
    # UTC: 15:20 / 19:20 / 23:20 / 03:20 / 07:20 / 11:20
    - cron: "20 15/4 * * *"
  workflow_dispatch: {}

jobs:
  call_api:
    runs-on: ubuntu-latest
    steps:
      - name: Wake server (optional)
        run: |
          curl -sS --max-time 20 "${{ secrets.RENDER_BASE_URL }}/health" || true

      - name: Trigger store endpoint (with retries)
        env:
          JOB_TOKEN: ${{ secrets.JOB_TOKEN }}
          BASE_URL: ${{ secrets.RENDER_BASE_URL }}
        run: |
          curl -sS -X POST \
            -H "x_job_token: ${JOB_TOKEN}" \
            --retry 5 --retry-all-errors --max-time 120 \
            "${BASE_URL}/api/v1/trends/realtime/store?geo=KR&hl=ko&hours=4"

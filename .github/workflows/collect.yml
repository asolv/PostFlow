name: collect-trends-via-api

on:
  schedule:
    - cron: "0 21 * * *"
    - cron: "30 23 * * *"
    - cron: "0 2 * * *"
    - cron: "30 4 * * *"
    - cron: "0 7 * * *"
    - cron: "30 9 * * *"
    - cron: "0 12 * * *"
    - cron: "0 14 * * *"
  workflow_dispatch: {}

jobs:
  call_api:
    runs-on: ubuntu-latest
    steps:
      - name: Wake server (optional)
        run: |
          curl -sS --max-time 20 "${{ secrets.RENDER_BASE_URL }}/health" || true

      - name: Trigger store endpoint (with retries)
        env:
          JOB_TOKEN: ${{ secrets.JOB_TOKEN }}
          BASE_URL: ${{ secrets.RENDER_BASE_URL }}
        run: |
          curl -sS -X POST \
            -H "x_job_token: ${JOB_TOKEN}" \
            --retry 5 --retry-all-errors --max-time 120 \
            "${BASE_URL}/api/v1/trends/realtime/store?geo=KR&hl=ko&hours=4"
